#!/bin/sh
file="$1"
x="$2"
y="$3"
height="$4"
width="$5"

ImageRemove() {
	printf '{"action": "remove", "identifier": "preview"\n' > "$UEBERZUG_FIFO"
}


ImageAdd() {
	printf '{"action": "add", "identifier": "preview", "x": "%d", "y": "%d", "width": "%d", "height": "%d", "scaler": "fit_contain", "path": "%s"}\n' $x $y $width $height "$file" > "$UEBERZUG_FIFO"
}


mime=$(file --mime-type --brief "$file")
case $mime in
	*/directory) ls -lA --color=always --group-directories-first ;;
	text/plain|text/x-shellscript|text/x-script.python)
		if command -v bat >/dev/null; then
			bat "$file"
		else
			head -n 500 "$file"
		fi
		;;

	image/*)
		if command -v ueberzug >/dev/null; then
			if [ -z "$UEBERZUG_FIFO" ]; then
				printf '$UEBERZUG_FIFO is not set...\n'
			elif ! command -v ueberzug >/dev/null; then
				printf 'Ueberzug is not installed...\n'
			elif [ -z "$x" ]; then
				printf 'X value is not given (2nd argument)...\n'
			elif [ -z "$y" ]; then
				printf 'Y value is not given (3rd argument)...\n'
			elif [ -z "$width" ]; then
				printf 'Width value is not given (4th argument)...\n'
			elif [ -z "$height" ]; then
				printf 'Height value is not given (5th argument)...\n'
			else
				ImageAdd
			fi
		elif command -v chafa >/dev/null; then
			chafa "$file"
		elif command -v ascii-image-converter >/dev/null; then
			ascii-image-converter "$file"
		else
			printf 'Ueberzug, chafa, and ascii-image-converter is not installed. Please install one of them to preview images\n'
		fi
		;;

	*) printf 'Preview for current mime-type is not implemented yet...\n'
esac
