#!/bin/sh
# I hate pulseaudio
# Changes the output device

output=$(pacmd list-cards)
options=$(printf '%s' "$output" | grep -Po '\s+output:.*: \K.*(?= [(]priority)')
returned=0
selected=1

lines=$(echo "$options" | wc -l)

printf '\033[33mj: UP;  K: Down;  Enter / Space: Select;  q: Quit\n'
printf '\033[33m              !!! NO ARROW KEYS !!!\n'
printf '%s\n' '-------------------------------------------------'
while [ $returned -eq 0 ]; do
	selectedString=$(echo "$options" | awk "NR==$selected{print}")

	echo "$options" | while read line; do
		[ "$selectedString" = "$line" ] &&
			printf '\033[7m'

		printf '%s\033[0m\n' "$line"
	done


 	read -rsn1 input
 	if [ "$input" = 'j' ] && [ ! $selected -eq $lines ]; then
 		selected=$(expr $selected + 1)
 	elif [ "$input" = 'k' ] && [ ! $selected -eq 1 ]; then
 		selected=$(expr $selected - 1)
 	elif [ "$input" = 'q' ] ; then
		returned=1
 	elif [ "$input" = ' ' ] || [ "$input" = '' ] ; then
		returned=$selected
 	fi

 	printf '\033[%iF' $lines
 	printf '\033[0J'
done

echo "Changing output device to: ${selectedString}"
profile=$(printf '%s' "$output" | grep "$selectedString (priority" | cut -d ':' -f 2)

pacmd set-card-profile 0 "output:${profile}"
if [ $? -eq 0 ]; then
	echo "Successfully changed device to ${selectedString}!"
	echo "Restarting pulseaudio"
	killall pulseaudio
	setsid -f pulseaudio --start --exit-idle-time=-1 && echo "Restarted pulseaudio"
else
	echo "Failed to change devices"
fi
