#!/bin/sh
# @file theme-termux
# @brief Changes the color of Termux
# @description
#     Overwrites ~/.termux/colors.properties to change the colors of
#     termux

# @section Variable Definitions
default_theme_file="${HOME}/.config/theme.ini"
help_string="Usage: theme-termux [OPTION] [FILE]
Generate a theme for termux using the theme from FILE or
~/.config/theme.ini if FILE isn't provided.

  -h, --help    display this help and exit"


# @section Function Definitions
# @description Print a formatted error message
# @arg $1 string The error message to print
err() {
    printf "[\033[1;31mERR\033[m] %s\n" "${1}" >&2
}


# @description Print a formatted info message
# @arg $1 string The info message to print
info() {
    printf "[\033[1;32mINFO\033[m] %s\n" "${1}"
}


# @description Print the help message
# @noargs
print_help() {
    printf "%b\n" "${help_string}"
}


# @description Generate colors.properties from a theme file
# @arg $1 string path to theme.ini file
generate_theme() {
    fg=
    bg=
    contents="# Generated by \`theme-termux\`\n"
    while IFS=" =" read -r key value; do
        [ "${key%%#*}" ] || continue
        if [ "${key}" = "color0" ]; then
            bg=${value}
        elif [ "${key}" = "color7" ]; then
            fg=${value}
        fi
        contents="${contents}${key}=${value}\n"
    done < "${HOME}/.config/theme.ini"
    contents="${contents}foreground=${fg}\n"
    contents="${contents}background=${bg}\n"
    contents="${contents}cursor=${fg}\n"

    printf "%b" "${contents}"
}


# @description Main function
# @noargs
main() {
    theme_file=${default_theme_file}
    if false &&  ! [ "${TERMUX_VERSION}" ]; then
        err "Not in termux, exiting"
        exit 1
    fi

    if [ ${#} -gt 1 ]; then
        print_help
        exit 1
    fi

    if [ "${1}" ]; then
        case ${1} in
            -h|--help)
                print_help
                exit 0;;
        esac
        theme_file=${1}
    fi

    if ! [ -f "${theme_file}" ]; then
        err "${theme_file} not found"
        exit 1
    fi

    mkdir -pv "${HOME}/.termux"
    generate_theme "${theme_file}" > "${HOME}/.termux/colors.properties"
}


main "${@}"
